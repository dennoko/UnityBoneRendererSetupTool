# Bone Renderer Setup Tool 使い方

このツールは、VRChatアバターやその衣装に対して、Animation Riggingの `Bone Renderer` コンポーネントを簡単にセットアップするためのUnity拡張機能です。
特に衣装のボーン設定において、アバターのボーン構造を参照してヒューマノイドボーンを自動的に特定し、可視化することができます。


## 事前準備：Animation Riggingのインストール

このツールを使用するには、Unity公式の **Animation Rigging** パッケージが必要です。
まだプロジェクトに導入していない場合は、以下の手順でインストールしてください。

1.  Unityエディタのメニューバーから `Window` > `Package Manager` を開きます。
2.  ウィンドウ左上の `+` ボタンの隣にあるドロップダウンメニューから **Unity Registry** を選択します。
3.  リストから **Animation Rigging** を探します（検索バーに "Animation Rigging" と入力するとすぐに見つかります）。
4.  **Install** ボタンをクリックします。

---

## 主な機能

1.  **アバターのボーン可視化設定**
    *   アバターのAnimatorコンポーネントからヒューマノイドボーンを自動検出し、BoneRendererを設定します。
2.  **衣装のボーン可視化設定（マッチング機能）**
    *   衣装のボーン名がアバターと完全一致しなくても、形状や命名規則（VRM、Blender形式など）から自動的に対応するアバターのボーンを推定し、BoneRendererを設定します。
    *   UpperChest（上胸）の有無の違いなども自動で吸収します。
3.  **カラー設定**
    *   アバター用と衣装用で、可視化するボーンの色を個別に設定できます。
4.  **ボーンセットアップツール（アドオン）**
    *   左右ボーン同期、均一スケールなど、ボーン編集を支援する機能を提供します。

---

## 使い方の手順

### 1. ツールウィンドウの表示

メニューバーから以下の項目を選択して、設定ウィンドウを開きます。

`dennokoworks` > `BoneRendererSetupTool`

### 2. カラー設定

ウィンドウ上部の「カラー設定」セクションで、ボーンの表示色を設定できます。
変更した色は保存され、次回以降のセットアップ時に自動的に適用されます。

*   **Avatar Color**: アバターのボーン表示色（デフォルト: 緑系統）
*   **Outfit Color**: 衣装のボーン表示色（デフォルト: オレンジ系統）

### 3. セットアップの実行

セットアップは「設定ウィンドウ」または「Hierarchyの右クリックメニュー」のどちらからでも実行できます。

#### 方法 A: 設定ウィンドウを使用する場合

1.  **アバターのセットアップ**
    *   Hierarchyにあるアバター（Animatorを持つGameObject）を、「アバター」欄にドラッグ&ドロップします。
    *   **入力と同時に自動的にBoneRendererがセットアップされます。**
    *   手動でセットアップする場合は `Setup` ボタンを押します。

2.  **衣装のセットアップ**
    *   「アバター」欄にアバターが設定されていることを確認します（衣装のマッチングに必要です）。
    *   Hierarchyにある衣装のルートオブジェクトを、「衣装」欄にドラッグ&ドロップします。
    *   **入力と同時に自動的にBoneRendererがセットアップされます。**
    *   手動でセットアップする場合は `Setup` ボタンを押します。

3.  **シーンからアバターを検索**
    *   「ユーティリティ」セクションの「シーンからアバターを検索」ボタンを押すと、シーン内のHumanoidアバターを自動検出します。
    *   見つかったアバターは自動的にセットアップされます。

#### 方法 B: 右クリックメニューを使用する場合

1.  **アバターのセットアップ**
    *   Hierarchyでアバターを選択し、右クリックします。
    *   `GameObject` > `BoneRendererSetupTool` > `Setup (Avatar)` を選択します。
    
2.  **衣装のセットアップ**
    *   **重要**: シーン内に比較対象となるアバター（Humanoid設定済み）が存在する必要があります。
    *   Hierarchyで衣装を選択し、右クリックします。
    *   `GameObject` > `BoneRendererSetupTool` > `Setup (Outfit → Avatar)` を選択します。
    *   シーン内にアバターが複数ある場合は、どのアバターと照合するかを選択するメニューが表示されます。

---

## BoneRendererの削除

設定済みのBoneRendererを削除したい場合は、以下のいずれかの操作を行います。

*   **ウィンドウから**
    *   `Remove Renderer` ボタンを押す。
    *   `Clear` ボタンを押すと、参照解除と同時にBoneRendererも削除されます。

*   **右クリックメニューから**
    *   対象のオブジェクトを右クリックし、 `GameObject` > `BoneRendererSetupTool` > `Remove (Avatar)` または `Remove (Outfit)` を選択する。

---

## アドオン機能

### ボーンセットアップツール

ボーン編集を支援する追加機能を提供します。ツールウィンドウの「Addons」セクションに表示されます。
**※各機能は、ツールに対象のアバターがセットされている時のみ有効になります。**

---

### 左右ボーン同期

ボーンの左右対称編集を自動化する機能です。

**機能概要**
*   選択したボーンの変更（位置・回転・スケール）を、対になるボーン（左右）に自動でミラーリングします。
*   例: `LeftUpperArm` を編集すると、`RightUpperArm` にも同じ変更が反映されます。

**対応するボーン命名規則**
*   `_L` / `_R` 形式（例: `Arm_L`, `Arm_R`）
*   `.L` / `.R` 形式（例: `Arm.L`, `Arm.R`）
*   `Left` / `Right` 形式（例: `LeftArm`, `RightArm`）
*   `左` / `右` 形式（例: `腕左`, `腕右`）

**設定項目**
| 項目 | 説明 |
|------|------|
| 同期を有効化 | 左右ボーン同期のON/OFF切り替え |

**MA Scale Adjuster との連携**
*   Modular Avatar の MA Scale Adjuster コンポーネントが設定されている場合、スケール値も自動で同期されます。
*   MA Scale Adjuster の「子オブジェクトの位置を調整」設定が有効な場合、同期先でも子オブジェクトの位置が自動調整されます。
*   コンポーネントを削除した場合、同期先のコンポーネントも自動で削除されます。

---

### 均一スケール

ボーンのスケールを X/Y/Z すべて同じ値に保つ機能です。

**機能概要**
*   Scale の X/Y/Z いずれかを変更すると、他の軸も自動で同じ値に揃います。
*   子ボーンが回転した際にスケールが歪む問題を防ぐために使用します。

**設定項目**
| 項目 | 説明 |
|------|------|
| 均一スケールを有効化 | 均一スケール機能のON/OFF切り替え |

**使用例**
1.  「均一スケールを有効化」をONにします。
2.  ボーンを選択し、Scale の X 値を変更します。
3.  Y, Z の値も自動的に X と同じ値になります。

**MA Scale Adjuster との連携**
*   ボーンに MA Scale Adjuster コンポーネントがある場合、そちらの Scale 値も自動で均一化されます。

---

## 注意事項

*   衣装のマッチング精度を上げるため、衣装のボーン構造は一般的な命名規則（例: `Hips`, `Spine`, `LeftUpperArm` や `Arm_L` など）に従っていることが望ましいです。
*   独自の名前を持つボーンの場合、自動マッチングで検出できないことがあります。
*   左右ボーン同期と均一スケールは、デフォルトで有効になっています。不要な場合はトグルをOFFにしてください。

---

## フィードバック・不具合報告

セットアップが上手くいかないヒューマノイドボーンがあった場合は、**ボーン名と合わせて**ご連絡ください。
対応パターンを追加することで改善できる可能性があります。

**連絡先**
*   BOOTH: [dennokoworks](https://dennokoworks.booth.pm/)
*   X (Twitter): [@dennoko_vrc](https://twitter.com/dennoko_vrc)
